<!DOCTYPE html>
<html lang="en-US">

<head>
    <title>Catbox</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3.0, minimum-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-black.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:100" rel="stylesheet" type="text/css">
    <link href="favicon.ico" rel="icon" type="image/x-icon" />
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script>
        $(document).ready(function () {
            // getBoxesSetup();
            // getStartData();
            // getSettings();
            setupBoxes();
        });

        function setupBoxes() {
            jQuery.getJSON("/names.json", function (dataNAMES) {
                var items = [];
                $.each(dataNAMES, function (index, value) {
                    items.push('<input id="' + index + '" class="w3-bar-item w3-padding w3-quarter" style="text-align: center; width:25%;"  name="' + index + '" value="' + value + '">');
                })
                items.push('<div class="w3-section w3-center"><button id="_save" type=submit class="w3-button w3-round-xlarge w3-padding-small">Save Settings</button></div>');
                items.join("");
                $('#form_settings').append(items);
            })
        };

        function getStartData() {
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var data = this.responseText;
                    var json = JSON.parse(data);
                    $("#title").text(json.title);
                    $("#version").text(json.version);
                }
            };
            xhttp.open("GET", "/JSONSTART", true);
            xhttp.send();
        }

        function populate(frm, data) {
            $.each(data, function (key, value) {
                var ctrl = $('[name=' + key + ']', frm);
                ctrl.val(value);
            });
        };

        function getSettings() {
            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var data = this.responseText;
                    var json = JSON.parse(data);
                    var form = document.getElementById("form_settings").form;
                    populate("form_settings", json);
                    $.each(json, function (key, val) {
                        if (val != 0)
                            $("#" + key).val(val);
                    });
                }
            };
            xmlhttp.open("GET", "/JSONSETTINGS", true);
            xmlhttp.send();
        };
        (function ($) {
            $.fn.toJSON = function () {
                var $elements = {};
                var $form = $(this);
                $form.find('input, select').each(function () {
                    var name = $(this).attr('name');
                    var type = $(this).attr('type');
                    if (name) {
                        var $value;
                        if (type == 'radio') {
                            $value = $('input[name=' + name + ']:checked', $form).val()
                        } else if (type == 'checkbox') {
                            $value = $(this).is(':checked')
                        } else {
                            $value = $(this).val()
                        }
                        $elements[$(this).attr('name')] = $value
                    }
                });
                return JSON.stringify($elements)
            };
            $.fn.fromJSON = function (json_string) {
                var $form = $(this);
                var data = JSON.parse(json_string);
                $.each(data, function (key, value) {
                    var $elem = $('[name="' + key + '"]', $form);
                    var type = $elem.first().attr('type');
                    if (type == 'radio') {
                        $('[name="' + key + '"][value="' + value + '"]').prop('checked', true)
                    } else if (type == 'checkbox' && (value == true || value == 'true')) {
                        $('[name="' + key + '"]').prop('checked', true)
                    } else {
                        $elem.val(value)
                    }
                })
            };
        }(jQuery));
        function postData() {
            var data = $("form#form_settings").toJSON();
            console.log(data);
            var url = "/SAVESETTINGS";
            var xhr = new XMLHttpRequest();
            xhr.open("POST", url, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(data);
            location.replace("/redirect");
            return false;
        };
    </script>
    <style>
        body,
        a,
        button,
        pre,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: "Roboto", sans-serif;
            margin: 0;
            padding: 0
        }

        body,
        html {
            height: 100%;
            width: 100%
        }

        hr,
        .div {
            margin: 1vh;
            padding: 0vh
        }

        .w3-bar-item {
            height: 15vmax;
        }
    </style>
</head>

<body class="w3-theme-dark w3-mobile" style="min-width:25%">
    <div style="text-align: center">
        <h1><b>Setup Box (<span id="title">BoxID</span>)</b></h1>
    </div>
    <hr class="w3-border-grey">
    <form action="javascript:postData()" id="form_settings" method="get" class="w3-padding-small w3-block"></form>
    <hr class="w3-border-grey">
    <div class="w3-section w3-center">
        <div>
            <a id="btnBack" href="/" class="w3-button w3-round-xlarge w3-padding-small">Back</a>
            <a id="btnRestart" href="/RESTART" class="w3-button w3-round-xlarge w3-padding-small">Restart</a>
        </div>
        <div>
            <span id="version">Version</span>
        </div>
    </div>
</body>

</html>